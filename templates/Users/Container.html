<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>You are about to delete Worker <b><i id="DeleteTitle"></i></b>.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" id="DeleteOk" class="btn btn-danger">Confirm Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-reassign" tabindex="-1" role="dialog" aria-labelledby="ReassignLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ReassignLabel">Confirm Reassign</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-center">You are about to reassign incomplete books of the worker</p>
                <table class="table table-sm table-borderless align-items-center">
                    <tbody>
                        <tr>
                            <td class="text-right">Name:</td>
                            <td><b><i id="ReassignTitle"></i></b></td>
                        </tr>
                        <tr>
                            <td class="text-right">Role:</td>
                            <td><b><span id="ReassignRole"></span></b></td>
                        </tr>
                    </tbody>
                </table>
                <p class="text-center">Books will be spread out among the other workers based on smallest queue sizes.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" id="ReassignOk" class="btn btn-primary">Confirm Reassign</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reassign-files" tabindex="-1" role="dialog" aria-labelledby="ReassignFiles" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ReassignFiles">Reassigned Books</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body scroll-large">
                <h5 class="text-center">Move files from &rarr; to the following destinations:</h5>
                <ul class="list-group" id="FilesDestinations"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 mb-4">
    <div class="col-12">
        <h2>{PAGE_TITLE}
            <small class="text-muted font-weight-light text-capitalize">&bullet; {LOGGED_FULL_NAME} | {LOGGED_ROLE}</small>
        </h2>
    </div>
</div>
<div class="row">
    <div class="col-12 mb-5">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-user-friends"></i>&nbsp;&nbsp;Worker List</h5>
                    </div>
                    <div class="card-body pl-0 pr-0">
                        <table class="table table-sm table-bordered" style="width: 100%" id="usersTable">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th nowrap="1">Pay Rate</th>
                                <th>Registered</th>
                                <th>Last Login</th>
                                <th></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-8 mb-5">
        {CREATE_USER}
    </div>
    <div class="col-4 mb-5">
        <div class="card">
            <h5 class="card-header"><i class="fa fa-key"></i>&nbsp;&nbsp;Change Password</h5>
            <div class="card-body">
                <form id="ChangePwForm" action="/users/" method="post">
                    <div class="form-group">
                        <input name="password_current" id="PasswordCurrent" class="form-control" type="password" placeholder="Current Password">
                    </div>
                    <div class="form-group">
                        <input name="password" id="Password" class="form-control" type="password" placeholder="New Password">
                    </div>
                    <div class="form-group">
                        <input name="password_c" id="ConfirmPassword" class="form-control" type="password" placeholder="Confirm New Password">
                    </div>
                    <button class="btn btn-secondary" type="submit">Change Password</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var table = $('#usersTable').DataTable({
            ajax: '/users/?ajax_users=1',
            stateSave: true,
            columnDefs: [
                {
                    targets: 7,
                    searchable: false,
                    orderable: false,
                    render: function (data, type, full, meta) {
                        return "<div class='text-center text-nowrap'>" + data + "</div>";
                    }
                },
                {
                    targets: [1,2],
                    render: function (data, type, full, meta) {
                        return "<div class='text-wrap width-kw-tag' title='" + data + "'>" + data + "</div>";
                    }
                },
                {
                    targets:[3,4,5,6],
                    render: function (data, type, full, meta) {
                        return "<div class='text-nowrap'>" + data + "</div>";
                    }
                }
            ],
            drawCallback: function(settings) {
                $("editrate").click(function() {
                    $("inputrate." + this.className).keypress(function(event) {
                        if (event.keyCode == 13) {
                            event.preventDefault();
                            save(this);
                        }
                    });

                    if ($(this).find("i").hasClass("fa-save")) {
                        save(this);
                    }
                    else {
                        $("inputrate." + this.className).attr("contenteditable", "true").css({"border":"#ccc solid 1px", "outline":"none", "padding":"3px", "border-radius":"3px"}).focus();
                        $(this).find("i").attr("title", "Save").addClass("fa-save text-danger");
                    }

                    function save(e) {
                        $("inputrate." + e.className).attr("contenteditable", "false").css({"border":"none", "outline":"none", "padding":"0", "border-radius":"none"});
                        $(e).find("i").attr("title", "CLick to Change").removeClass("fa-save text-danger").addClass('fa-edit text-primary');
                        var userId = e.className;
                        var newRate = parseFloat($("inputrate." + e.className).text());
                        $.post('/users', { ajax_user_id: userId, ajax_base_pay_rate: newRate }).done(function(data) {
                            console.log(data);
                            table.ajax.reload(null, false);
                        });
                    }
                });

                $("editrole").click(function() {
                    if ($(this).find("i").hasClass("fa-save")) {
                        $("select." + this.className).hide();
                        $('span.' + this.className).show();
                        $(this).find("i").attr("title", "CLick to Change").removeClass("fa-save text-danger").addClass('fa-edit text-primary');
                        var userId = this.className;
                        var newRole = parseInt($("select." + this.className).val());
                        console.log(newRole);
                        $.post('/users', { ajax_user_id: userId, ajax_role: newRole }).done(function(data) {
                            console.log(data);
                            table.ajax.reload(null, false);
                        });
                    }
                    else {
                        $("select." + this.className).show();
                        $('span.' + this.className).hide();
                        $(this).find("i").attr("title", "Save").addClass("fa-save text-danger");
                    }
                });
            }
        });

        $('#confirm-reassign').on('show.bs.modal', function (e) {
            var data = $(e.relatedTarget).data();
            $('#ReassignTitle', this).text(data.recordTitle);
            $('#ReassignRole', this).text(data.recordRole);
            $('#ReassignOk', this).data('recordId', data.recordId);
        });

        $('#confirm-reassign').on('click', '#ReassignOk', function (e) {
            var $modalDiv = $(e.delegateTarget);
            var id = $(this).data('recordId');

            $.post("/users/", {reassign_user_id: id}).done(function (data) {
                $modalDiv.modal('hide');
                $('#FilesDestinations').html(data);
                $('#reassign-files').modal();
                // console.log(data);
                table.ajax.reload(null, false);
            });
        });
    });

    $('#ChangePwForm').validate({
        rules: {
            password_current: {
                required: true
            },
            password: {
                required: true,
                minlength: 5
            },
            password_c: {
                required: true,
                minlength: 5,
                equalTo: "#Password"
            }
        },
        messages: {
            password_current: {
                required: "Provide your current password"
            },
            password: {
                required: "Provide new password",
                minlength: "Your password must be at least 5 characters long"
            },
            password_c: {
                required: "Confirm new password",
                minlength: "Your password must be at least 5 characters long",
                equalTo: "Enter the same password as above"
            }
        }
    });

    $('#confirm-delete').on('show.bs.modal', function (e) {
        var data = $(e.relatedTarget).data();
        $('#DeleteTitle', this).text(data.recordTitle);
        $('#DeleteOk', this).data('recordId', data.recordId);
    });

    $('#confirm-delete').on('click', '#DeleteOk', function (e) {
        var $modalDiv = $(e.delegateTarget);
        var id = $(this).data('recordId');

        $.post('/users/', {delete_user_id: id}).done(function () {
            $modalDiv.modal('hide');
            location.reload();
        });
    });
</script>